package com.xsecret.controller;

import com.xsecret.dto.request.LotteryResultRequest;
import com.xsecret.dto.response.ApiResponse;
import com.xsecret.dto.response.LotteryResultResponse;
import com.xsecret.entity.LotteryResult;
import com.xsecret.repository.LotteryResultRepository;
import com.xsecret.service.LotteryResultService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Controller qu·∫£n l√Ω k·∫øt qu·∫£ x·ªï s·ªë
 * Admin endpoints: CRUD k·∫øt qu·∫£
 * Public endpoints: Xem k·∫øt qu·∫£ ƒë√£ published
 */
@RestController
@RequestMapping
@RequiredArgsConstructor
@Slf4j
@CrossOrigin(origins = "*", maxAge = 3600)
public class LotteryResultController {

    private final LotteryResultService lotteryResultService;
    private final LotteryResultRepository lotteryResultRepository;

    // ==================== ADMIN ENDPOINTS ====================

    /**
     * Admin: T·∫°o k·∫øt qu·∫£ x·ªï s·ªë m·ªõi
     */
    @PostMapping("/admin/lottery-results")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<LotteryResultResponse>> createLotteryResult(
            @RequestBody LotteryResultRequest request) {
        log.info("Admin creating lottery result: region={}, province={}, drawDate={}", 
                request.getRegion(), request.getProvince(), request.getDrawDate());
        
        try {
            LotteryResultResponse response = lotteryResultService.createLotteryResult(request);
            return ResponseEntity.ok(ApiResponse.success("T·∫°o k·∫øt qu·∫£ th√†nh c√¥ng", response));
        } catch (Exception e) {
            log.error("Error creating lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói t·∫°o k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: C·∫≠p nh·∫≠t k·∫øt qu·∫£ x·ªï s·ªë
     */
    @PutMapping("/admin/lottery-results/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<LotteryResultResponse>> updateLotteryResult(
            @PathVariable Long id,
            @RequestBody LotteryResultRequest request) {
        log.info("Admin updating lottery result ID: {}", id);
        
        try {
            LotteryResultResponse response = lotteryResultService.updateLotteryResult(id, request);
            return ResponseEntity.ok(ApiResponse.success("C·∫≠p nh·∫≠t k·∫øt qu·∫£ th√†nh c√¥ng", response));
        } catch (Exception e) {
            log.error("Error updating lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói c·∫≠p nh·∫≠t k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: X√≥a k·∫øt qu·∫£ x·ªï s·ªë
     */
    @DeleteMapping("/admin/lottery-results/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<Void>> deleteLotteryResult(@PathVariable Long id) {
        log.info("Admin deleting lottery result ID: {}", id);
        
        try {
            lotteryResultService.deleteLotteryResult(id);
            return ResponseEntity.ok(ApiResponse.success("X√≥a k·∫øt qu·∫£ th√†nh c√¥ng", null));
        } catch (Exception e) {
            log.error("Error deleting lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói x√≥a k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: Publish k·∫øt qu·∫£ (chuy·ªÉn t·ª´ DRAFT sang PUBLISHED)
     * T·ª± ƒë·ªông check bet ngay sau khi publish
     */
    @PostMapping("/admin/lottery-results/{id}/publish")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<LotteryResultResponse>> publishResult(@PathVariable Long id) {
        log.info("Admin publishing lottery result ID: {}", id);

        try {
            LotteryResultResponse response = lotteryResultService.publishResult(id);
            
            // Trigger auto bet check ngay sau khi publish
            try {
                log.info("üöÄ Triggering auto bet check after admin publish for date: {}", response.getDrawDate());
                betService.checkBetResultsForDate(response.getDrawDate().toString());
                log.info("‚úÖ Auto bet check completed after admin publish");
            } catch (Exception e) {
                log.error("‚ùå Error during auto bet check after publish: {}", e.getMessage());
                // Kh√¥ng throw exception, ch·ªâ log l·ªói
            }

            return ResponseEntity.ok(ApiResponse.success("C√¥ng b·ªë k·∫øt qu·∫£ th√†nh c√¥ng v√† ƒë√£ check bet t·ª± ƒë·ªông.", response));
        } catch (Exception e) {
            log.error("Error publishing lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói c√¥ng b·ªë k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: Manual trigger check bet cho ng√†y c·ª• th·ªÉ
     * D√πng ƒë·ªÉ test v√† debug
     */
    @PostMapping("/admin/lottery-results/check-bets/{date}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<String>> manualCheckBets(@PathVariable String date) {
        log.info("Admin manually triggering bet check for date: {}", date);
        
        try {
            betService.checkBetResultsForDate(date);
            return ResponseEntity.ok(ApiResponse.success("Manual bet check completed for date: " + date, null));
        } catch (Exception e) {
            log.error("Error during manual bet check for date: {}", date, e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói check bet: " + e.getMessage()));
        }
    }

    /**
     * Admin: Trigger auto-import lottery results t·ª´ API
     * Import t·∫•t c·∫£ k·∫øt qu·∫£ c√≤n thi·∫øu (Mi·ªÅn B·∫Øc + c√°c t·ªânh)
     */
    @PostMapping("/admin/lottery-results/auto-import")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<Map<String, Object>>> triggerAutoImport() {
        log.info("Admin triggering auto-import lottery results...");

        try {
            Map<String, Object> result = new HashMap<>();
            int totalImported = 0;
            List<String> errors = new ArrayList<>();

            // Import Mi·ªÅn B·∫Øc
            try {
                autoImportService.autoImportMienBac();
                totalImported++;
                result.put("mienBac", "Success");
            } catch (Exception e) {
                log.error("Error importing Mi·ªÅn B·∫Øc: {}", e.getMessage());
                errors.add("Mi·ªÅn B·∫Øc: " + e.getMessage());
                result.put("mienBac", "Failed: " + e.getMessage());
            }

            // Import c√°c t·ªânh
            String[] provinces = {"gialai", "binhduong", "ninhthuan", "travinh", "vinhlong"};
            for (String province : provinces) {
                try {
                    autoImportService.autoImportProvince(province);
                    totalImported++;
                    result.put(province, "Success");
                } catch (Exception e) {
                    log.error("Error importing province {}: {}", province, e.getMessage());
                    errors.add(province + ": " + e.getMessage());
                    result.put(province, "Failed: " + e.getMessage());
                }
            }

            result.put("totalImported", totalImported);
            result.put("totalProvinces", provinces.length + 1); // +1 for Mi·ªÅn B·∫Øc
            result.put("errors", errors);

            String message = String.format("Auto-import ho√†n th√†nh: %d/%d th√†nh c√¥ng", 
                    totalImported, provinces.length + 1);

            return ResponseEntity.ok(ApiResponse.success(message, result));
        } catch (Exception e) {
            log.error("Error during auto-import", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói auto-import: " + e.getMessage()));
        }
    }

    /**
     * Admin: Unpublish k·∫øt qu·∫£ (chuy·ªÉn t·ª´ PUBLISHED v·ªÅ DRAFT)
     */
    @PostMapping("/admin/lottery-results/{id}/unpublish")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<LotteryResultResponse>> unpublishResult(@PathVariable Long id) {
        log.info("Admin unpublishing lottery result ID: {}", id);
        
        try {
            LotteryResultResponse response = lotteryResultService.unpublishResult(id);
            return ResponseEntity.ok(ApiResponse.success("H·ªßy c√¥ng b·ªë k·∫øt qu·∫£ th√†nh c√¥ng", response));
        } catch (Exception e) {
            log.error("Error unpublishing lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói h·ªßy c√¥ng b·ªë k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: L·∫•y t·∫•t c·∫£ k·∫øt qu·∫£ (c√≥ ph√¢n trang)
     */
    @GetMapping("/admin/lottery-results")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<Page<LotteryResultResponse>>> getAllLotteryResults(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        log.info("Admin getting all lottery results: page={}, size={}", page, size);
        
        try {
            Pageable pageable = PageRequest.of(page, size);
            Page<LotteryResultResponse> results = lotteryResultService.getAllLotteryResults(pageable);
            return ResponseEntity.ok(ApiResponse.success(results));
        } catch (Exception e) {
            log.error("Error getting lottery results", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói l·∫•y k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: L·∫•y k·∫øt qu·∫£ theo region
     */
    @GetMapping("/admin/lottery-results/region/{region}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<Page<LotteryResultResponse>>> getLotteryResultsByRegion(
            @PathVariable String region,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        log.info("Admin getting lottery results by region: {}", region);
        
        try {
            Pageable pageable = PageRequest.of(page, size);
            Page<LotteryResultResponse> results = lotteryResultService.getLotteryResultsByRegion(region, pageable);
            return ResponseEntity.ok(ApiResponse.success(results));
        } catch (Exception e) {
            log.error("Error getting lottery results by region", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói l·∫•y k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: L·∫•y k·∫øt qu·∫£ theo region v√† province
     */
    @GetMapping("/admin/lottery-results/region/{region}/province/{province}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<Page<LotteryResultResponse>>> getLotteryResultsByRegionAndProvince(
            @PathVariable String region,
            @PathVariable String province,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        log.info("Admin getting lottery results by region and province: {}, {}", region, province);
        
        try {
            Pageable pageable = PageRequest.of(page, size);
            Page<LotteryResultResponse> results = lotteryResultService.getLotteryResultsByRegionAndProvince(
                    region, province, pageable);
            return ResponseEntity.ok(ApiResponse.success(results));
        } catch (Exception e) {
            log.error("Error getting lottery results by region and province", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói l·∫•y k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: L·∫•y k·∫øt qu·∫£ theo province
     */
    @GetMapping("/admin/lottery-results/province/{province}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<Page<LotteryResultResponse>>> getLotteryResultsByProvince(
            @PathVariable String province,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        log.info("Admin getting lottery results by province: {}", province);
        
        try {
            Pageable pageable = PageRequest.of(page, size);
            Page<LotteryResultResponse> results = lotteryResultService.getLotteryResultsByProvince(province, pageable);
            return ResponseEntity.ok(ApiResponse.success(results));
        } catch (Exception e) {
            log.error("Error getting lottery results by province", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói l·∫•y k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Admin: L·∫•y k·∫øt qu·∫£ theo ID
     */
    @GetMapping("/admin/lottery-results/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<LotteryResultResponse>> getLotteryResult(@PathVariable Long id) {
        log.info("Admin getting lottery result ID: {}", id);
        
        try {
            LotteryResultResponse response = lotteryResultService.getLotteryResult(id);
            return ResponseEntity.ok(ApiResponse.success(response));
        } catch (Exception e) {
            log.error("Error getting lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói l·∫•y k·∫øt qu·∫£: " + e.getMessage()));
        }
    }


    // ==================== PUBLIC ENDPOINTS ====================

    /**
     * Public: L·∫•y k·∫øt qu·∫£ ƒë√£ published theo region v√† drawDate
     */
    @GetMapping("/public/lottery-results/{region}/{drawDate}")
    public ResponseEntity<ApiResponse<LotteryResultResponse>> getPublishedResult(
            @PathVariable String region,
            @PathVariable String drawDate,
            @RequestParam(required = false) String province) {
        log.info("Getting published lottery result: region={}, province={}, drawDate={}", 
                region, province, drawDate);
        
        try {
            LocalDate date = LocalDate.parse(drawDate, DateTimeFormatter.ISO_LOCAL_DATE);
            LotteryResult result = lotteryResultService.getPublishedResultForBetCheck(region, province, date);
            
            if (result == null) {
                return ResponseEntity.ok(ApiResponse.error("Ch∆∞a c√≥ k·∫øt qu·∫£ cho ng√†y n√†y"));
            }
            
            return ResponseEntity.ok(ApiResponse.success(LotteryResultResponse.fromEntity(result)));
        } catch (Exception e) {
            log.error("Error getting published lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói l·∫•y k·∫øt qu·∫£: " + e.getMessage()));
        }
    }

    /**
     * Debug: Ki·ªÉm tra k·∫øt qu·∫£ cho bet check
     */
    @GetMapping("/debug/lottery-results/check")
    public ResponseEntity<ApiResponse<Object>> debugCheckLotteryResult(
            @RequestParam String region,
            @RequestParam(required = false) String province,
            @RequestParam String drawDate) {
        log.info("Debug check lottery result: region={}, province={}, drawDate={}", 
                region, province, drawDate);
        
        try {
            LocalDate date = LocalDate.parse(drawDate, DateTimeFormatter.ISO_LOCAL_DATE);
            LotteryResult result = lotteryResultService.getPublishedResultForBetCheck(region, province, date);
            
            if (result == null) {
                return ResponseEntity.ok(ApiResponse.error("Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ published cho region=" + region + 
                    ", province=" + province + ", drawDate=" + drawDate));
            }
            
            java.util.Map<String, Object> responseData = new java.util.HashMap<>();
            responseData.put("id", result.getId());
            responseData.put("region", result.getRegion());
            responseData.put("province", result.getProvince());
            responseData.put("drawDate", result.getDrawDate());
            responseData.put("status", result.getStatus());
            responseData.put("results", result.getResults());
            
            return ResponseEntity.ok(ApiResponse.success("T√¨m th·∫•y k·∫øt qu·∫£", responseData));
        } catch (Exception e) {
            log.error("Error debug check lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói debug: " + e.getMessage()));
        }
    }
    
    /**
     * Debug: Li·ªát k√™ t·∫•t c·∫£ k·∫øt qu·∫£ published
     */
    @GetMapping("/debug/lottery-results/list-published")
    public ResponseEntity<ApiResponse<Object>> listAllPublishedResults() {
        log.info("Debug list all published lottery results");
        
        try {
            // Query direct t·ª´ repository
            java.util.List<LotteryResult> allResults = lotteryResultRepository.findByStatusOrderByDrawDateDesc(
                LotteryResult.ResultStatus.PUBLISHED, org.springframework.data.domain.PageRequest.of(0, 100))
                .getContent();
            
            java.util.List<java.util.Map<String, Object>> resultList = allResults.stream()
                .map(result -> {
                    java.util.Map<String, Object> map = new java.util.HashMap<>();
                    map.put("id", result.getId());
                    map.put("region", result.getRegion());
                    map.put("province", result.getProvince() != null ? result.getProvince() : "null");
                    map.put("drawDate", result.getDrawDate().toString());
                    map.put("status", result.getStatus().toString());
                    map.put("hasResults", result.getResults() != null && !result.getResults().trim().isEmpty());
                    return map;
                })
                .collect(java.util.stream.Collectors.toList());
            
            java.util.Map<String, Object> responseData = new java.util.HashMap<>();
            responseData.put("count", resultList.size());
            responseData.put("results", resultList);
            
            return ResponseEntity.ok(ApiResponse.success("Danh s√°ch k·∫øt qu·∫£ published", responseData));
        } catch (Exception e) {
            log.error("Error listing published lottery results", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói list: " + e.getMessage()));
        }
    }

    /**
     * Public: L·∫•y k·∫øt qu·∫£ m·ªõi nh·∫•t ƒë√£ published theo region
     */
    @GetMapping("/public/lottery-results/{region}/latest")
    public ResponseEntity<ApiResponse<LotteryResultResponse>> getLatestPublishedResult(
            @PathVariable String region,
            @RequestParam(required = false) String province) {
        log.info("Getting latest published lottery result: region={}, province={}", region, province);
        
        try {
            LotteryResult result = lotteryResultService.getLatestPublishedResult(region, province);
            
            if (result == null) {
                return ResponseEntity.ok(ApiResponse.error("Ch∆∞a c√≥ k·∫øt qu·∫£"));
            }
            
            return ResponseEntity.ok(ApiResponse.success(LotteryResultResponse.fromEntity(result)));
        } catch (Exception e) {
            log.error("Error getting latest published lottery result", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói l·∫•y k·∫øt qu·∫£: " + e.getMessage()));
        }
    }
    
    // ==================== TEST/DEBUG ENDPOINTS ====================
    
    private final com.xsecret.service.lottery.LotteryResultAutoImportService autoImportService;
    private final com.xsecret.service.BetService betService;
    
    /**
     * Admin: Test import Mi·ªÅn B·∫Øc manually
     */
    @PostMapping("/admin/lottery-results/test-import/mien-bac")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<String>> testImportMienBac() {
        log.info("Admin manually triggering Mi·ªÅn B·∫Øc import test");
        
        try {
            autoImportService.autoImportMienBac();
            return ResponseEntity.ok(ApiResponse.success("Import Mi·ªÅn B·∫Øc th√†nh c√¥ng", null));
        } catch (Exception e) {
            log.error("Test import Mi·ªÅn B·∫Øc failed", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói import: " + e.getMessage()));
        }
    }
    
    /**
     * Admin: Test import 1 t·ªânh manually
     */
    @PostMapping("/admin/lottery-results/test-import/province/{province}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<String>> testImportProvince(@PathVariable String province) {
        log.info("Admin manually triggering {} import test", province);
        
        try {
            autoImportService.autoImportProvince(province);
            return ResponseEntity.ok(ApiResponse.success("Import " + province + " th√†nh c√¥ng", null));
        } catch (Exception e) {
            log.error("Test import {} failed", province, e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói import: " + e.getMessage()));
        }
    }
    
    /**
     * Admin: Test import t·∫•t c·∫£ c√°c t·ªânh manually
     */
    @PostMapping("/admin/lottery-results/test-import/all-provinces")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse<String>> testImportAllProvinces() {
        log.info("Admin manually triggering all provinces import test");
        
        try {
            autoImportService.autoImportAllProvinces();
            return ResponseEntity.ok(ApiResponse.success("Import t·∫•t c·∫£ t·ªânh th√†nh c√¥ng", null));
        } catch (Exception e) {
            log.error("Test import all provinces failed", e);
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error("L·ªói import: " + e.getMessage()));
        }
    }
}

